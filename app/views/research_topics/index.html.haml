%h1.mx-auto.text-center.mt-3= "Research Topics"
.container-md.mx-auto.p-0
  %button.mb-3.fs-5.btn.btn-primary{data: { bs: { toggle: "modal", target: "#addTopicModal" } } }= "Add Topic"
  .modal#addTopicModal{ tabindex: "-1" }
    .modal-dialog
      .modal-content
        .modal-header
          %h5.modal-title= "New Topic"
        .modal-body
          = form_for ResearchTopic.new do |f|
            .mb-3
              = f.label :title, class: "form-label"
              = f.text_field :title, class: "form-control mb-3"
              = f.label :search_terms, "Search Terms (add up to 5)", class: "form-label"
              - 5.times do |n|
                = f.text_field :search_terms, value: "",  id: "searchTerm#{n}", name: "research_topic[search_terms][]", class: "form-control mb-2"
              = f.submit "Add", class: "btn btn-primary"
  - ResearchTopic.all.each.with_index do |topic, topic_number|
    .modal{id: "topic-#{topic_number}-SearchTermModal", tabindex: "-1" }
      .modal-dialog
        .modal-content
          .modal-body
            = form_for SearchTerm.new do |f|
              .mb-3
                = f.label :term, "New Term For #{topic.title}", class: "form-label" 
                = f.text_field :term, class: "form-control mb-3"
                = f.hidden_field :research_topic_id, value: topic.id
                = f.submit "Add", class: "btn btn-primary"
    %h2= topic.title
    .row
      .col-auto
        %h4= "Search Terms:"
      .col-9 
        .row.gy-2
          - topic.search_terms.each do |term|
            .col-auto
              = form_for term, method: :delete  do |f|
                %p.fs-5.text-dark
                  = term.term
                  %button.btn-close(type="submit" aria-label="Close")
          .col-auto
            %button.btn.btn-primary{ data: { bs: { toggle: "modal", target: "#topic-#{topic_number}-SearchTermModal" } } }= "Add Term"
    - if topic.research_articles.length == 0
      %h4.p-3.my-3.bg-secondary= "There were no articles found for your search."
    - else
      .accordion.my-3.bg-light{ id: "topic-#{topic_number}-articlesAccordion" }
        .accordion-item
          %h2.accordion-header{ id: "topic-#{topic_number}-new" }
            %button.accordion-button.collapsed{ type: "button", data: { bs: { toggle: "collapse", target: "#topic-#{topic_number}-newArticlesCollapse" } }, aria: { expanded: "false", controls: "topic-#{topic_number}-newArticlesCollapse" } }
              = "New"
              %span.badge.bg-primary.ms-3= topic.research_articles.where(status: "new").length 
              - if topic.new_today_count > 0
                %span.ms-3.text-success= "#{topic.new_today_count} New Today"
          .collapse.accordion-collapse{ id: "topic-#{topic_number}-newArticlesCollapse" , aria: { labelledby: "topic-#{topic_number}-new" } }
            .accordion-body
              .accordion{ id: "topic-#{topic_number}-newAccordion" }
                - if topic.research_articles.where(status: "new").length == 0
                  %p= "It looks like there aren't any articles you haven't seen before. Try adding a new search term for more results."
                - topic.research_articles.where(status: "new").each.with_index do |article, article_number|
                  .accordion-item
                    %h2.accordion-header{ id: "topic-#{topic_number}-newArticle-#{article_number}" }
                      %button.accordion-button.collapsed{ type: "button", data: { bs: { toggle: "collapse", target: "#topic-#{topic_number}-newArticle-#{article_number}-collapse" } }, aria: { expanded: "false", controls: "topic-#{topic_number}-newArticle-#{article_number}-collapse" } }
                        .container
                          .row= article.title
                          .row.mt-3.text-muted= article.article_published
                    .collapse.accordion-collapse{ id: "topic-#{topic_number}-newArticle-#{article_number}-collapse", aria: { labelledby: "topic-#{topic_number}-newArticle-#{article_number}" } }
                      .accordion-body
                        = render 'shared/research_article', article: article
        .accordion-item
          %h2.accordion-header{ id: "topic-#{topic_number}-saved" }
            %button.accordion-button.collapsed{ type: "button", data: { bs: { toggle: "collapse", target: "#topic-#{topic_number}-savedArticlesCollapse" } }, aria: { expanded: "false", controls: "topic-#{topic_number}-savedArticlesCollapse" } }
              = "Saved"
              %span.badge.bg-primary.ms-3= topic.research_articles.where(status: "saved").length 
          .collapse.accordion-collapse{ id: "topic-#{topic_number}-savedArticlesCollapse", aria: { labelledby: "topic-#{topic_number}-saved" } }
            .accordion-body
              .accordion.bg-light{ id: "topic-#{topic_number}-savedAccordion" }
                - topic.research_articles.where(status: "saved").each.with_index do |article, article_number|
                  .accordion-item
                    %h2.accordion-header{ id: "topic-#{topic_number}-savedArticle-#{article_number}" }
                      %button.accordion-button.collapsed{ type: "button", data: { bs: { toggle: "collapse", target: "#topic-#{topic_number}-savedArticle-#{article_number}-collapse" } }, aria: { expanded: "false", controls: "topic-#{topic_number}-savedArticle-#{article_number}-collapse" } }
                        .container
                          .row= article.title
                          .row.mt-3.text-muted= article.article_published
                    .collapse.accordion-collapse{ id: "topic-#{topic_number}-savedArticle-#{article_number}-collapse", aria: { labelledby: "topic-#{topic_number}-savedArticle-#{article_number}" } }
                      .accordion-body
                        = render 'shared/research_article', article: article
        .accordion-item
          %h2.accordion-header{ id: "topic-#{topic_number}-read" }
            %button.accordion-button.collapsed{ type: "button", data: { bs: { toggle: "collapse", target: "#topic-#{topic_number}-readArticlesCollapse" } }, aria: { expanded: "false", controls: "topic-#{topic_number}-readArticlesCollapse" } }
              = "Read"
              %span.ms-3.badge.bg-primary= topic.research_articles.where(status: "read").length  
          .collapse.accordion-collapse{ id: "topic-#{topic_number}-readArticlesCollapse", aria: { labelledby: "topic-#{topic_number}-read" } }
            .accordion-body
              .accordion{ id: "topic-#{topic_number}-readAccordion" }
                - topic.research_articles.where(status: "read").each.with_index do |article, article_number|
                  .accordion-item
                    %h2.accordion-header{ id: "topic-#{topic_number}-readArticle-#{article_number}" }
                      %button.accordion-button.collapsed{ type: "button", data: { bs: { toggle: "collapse", target: "#topic-#{topic_number}-readArticle-#{article_number}-collapse" } }, aria: { expanded: "false", controls: "topic-#{topic_number}-readArticle-#{article_number}-collapse" } }
                        .container
                          .row= article.title
                          .row.mt-3.text-muted= article.article_published
                    .collapse.accordion-collapse{ id: "topic-#{topic_number}-readArticle-#{article_number}-collapse", aria: { labelledby: "topic-#{topic_number}-readArticle-#{article_number}" } }
                      .accordion-body
                        = render 'shared/research_article', article: article
